From 1dcda48399b549193f62a265e4f9199b768200e0 Mon Sep 17 00:00:00 2001
From: Will Dietz <w@wdtz.org>
Date: Mon, 2 Apr 2018 14:45:40 -0500
Subject: [PATCH] systemctl: support kill-user-manager alias

---
 meson.build                        |  3 ++-
 src/systemctl/systemctl.c          | 10 ++++++++++
 units/user/systemd-exit.service.in |  2 +-
 3 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/meson.build b/meson.build
index b53dfaa94..a30454fd5 100644
--- a/meson.build
+++ b/meson.build
@@ -273,6 +273,7 @@ substs.set('systemsleepdir',                                  systemsleepdir)
 substs.set('VARLOGDIR',                                       varlogdir)
 substs.set('CERTIFICATEROOT',                                 get_option('certificate-root'))
 substs.set('SYSTEMCTL',                                       join_paths(rootbindir, 'systemctl'))
+substs.set('KILLUSERMANAGER',                                 join_paths(rootbindir, 'kill-user-manager'))
 substs.set('RANDOM_SEED',                                     join_paths(randomseeddir, 'random-seed'))
 substs.set('SYSTEM_SYSVINIT_PATH',                            sysvinit_path)
 substs.set('SYSTEM_SYSVRCND_PATH',                            sysvrcnd_path)
@@ -1725,7 +1726,7 @@ exe = executable('systemctl', 'src/systemctl/systemctl.c',
                  install_dir : rootbindir)
 public_programs += [exe]
 
-foreach alias : ['halt', 'poweroff', 'reboot', 'runlevel', 'shutdown', 'telinit']
+foreach alias : ['halt', 'poweroff', 'reboot', 'runlevel', 'shutdown', 'telinit', 'kill-user-manager']
         meson.add_install_script(meson_make_symlink,
                                  join_paths(rootbindir, 'systemctl'),
                                  join_paths(rootsbindir, alias))
diff --git a/src/systemctl/systemctl.c b/src/systemctl/systemctl.c
index 12fca4ef9..2ccc4e630 100644
--- a/src/systemctl/systemctl.c
+++ b/src/systemctl/systemctl.c
@@ -8175,6 +8175,16 @@ static int parse_argv(int argc, char *argv[]) {
                 } else if (strstr(program_invocation_short_name, "runlevel")) {
                         arg_action = ACTION_RUNLEVEL;
                         return runlevel_parse_argv(argc, argv);
+                } else if (strstr(program_invocation_short_name, "kill-user-manager")) {
+                        if (argc != 2) {
+                          log_error("%s: require argument 'PID' missing, or too many arguments.", program_invocation_short_name);
+                          return -EINVAL;
+                        }
+                        uint32_t pid;
+                        int q = safe_atou32(argv[1], &pid);
+                        if (q < 0)
+                          return -EINVAL;
+                        return kill(pid, SIGRTMIN+24);
                 }
         }
 
diff --git a/units/user/systemd-exit.service.in b/units/user/systemd-exit.service.in
index 9ce6f1c2a..d56c0fcf9 100644
--- a/units/user/systemd-exit.service.in
+++ b/units/user/systemd-exit.service.in
@@ -16,4 +16,4 @@ After=shutdown.target
 
 [Service]
 Type=oneshot
-ExecStart=@KILL@ -s 58 $MANAGERPID
+ExecStart=@KILLUSERMANAGER@ $MANAGERPID
-- 
2.16.3

